<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lighting & Smoothing Demo</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      overflow: hidden;
    }
    
    #viewer-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    
    .controls-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      max-height: 90vh;
      overflow-y: auto;
      width: 320px;
    }
    
    .controls-panel h2 {
      margin-top: 0;
      color: #fbbf24;
      font-size: 1.5rem;
      border-bottom: 2px solid #fbbf24;
      padding-bottom: 10px;
    }
    
    .control-group {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }
    
    .control-group h3 {
      margin-top: 0;
      color: #60a5fa;
      font-size: 1.1rem;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      margin: 10px 0;
      justify-content: space-between;
    }
    
    label {
      flex: 1;
      margin-right: 10px;
      font-size: 0.9rem;
    }
    
    input[type="range"] {
      flex: 1.5;
      margin: 0 10px;
    }
    
    input[type="checkbox"] {
      margin-right: 10px;
    }
    
    .value-display {
      min-width: 50px;
      text-align: right;
      font-family: monospace;
      color: #fbbf24;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 5px;
      transition: transform 0.2s;
    }
    
    button:hover {
      transform: scale(1.05);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    .preset-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    
    .info-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      font-size: 0.9rem;
      max-width: 200px;
    }
    
    .info-item {
      margin: 5px 0;
    }
    
    .info-label {
      color: #60a5fa;
    }
    
    .info-value {
      color: #fbbf24;
      font-family: monospace;
    }
    
    input[type="color"] {
      width: 50px;
      height: 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="viewer-container"></div>
  
  <div class="controls-panel">
    <h2>üé® Lighting & Smoothing Demo</h2>
    
    <!-- Material Properties -->
    <div class="control-group">
      <h3>üí° Material Properties</h3>
      
      <div class="control-row">
        <label>Base Color:</label>
        <input type="color" id="base-color" value="#a9a9a9">
      </div>
      
      <div class="control-row">
        <label>Shininess:</label>
        <input type="range" id="shininess" min="0" max="200" value="50">
        <span class="value-display" id="shininess-value">50</span>
      </div>
      
      <div class="control-row">
        <label>Specular Color:</label>
        <input type="color" id="specular-color" value="#666666">
      </div>
      
      <div class="control-row">
        <label>Emissive Color:</label>
        <input type="color" id="emissive-color" value="#0a0a0a">
      </div>
      
      <div class="control-row">
        <label>Emissive Intensity:</label>
        <input type="range" id="emissive-intensity" min="0" max="100" value="10">
        <span class="value-display" id="emissive-intensity-value">10</span>
      </div>
      
      <div class="control-row">
        <label>Opacity:</label>
        <input type="range" id="opacity" min="0" max="100" value="100">
        <span class="value-display" id="opacity-value">100</span>
      </div>
    </div>
    
    <!-- Shading Options -->
    <div class="control-group">
      <h3>üî≤ Shading Options</h3>
      
      <div class="control-row">
        <input type="checkbox" id="flat-shading">
        <label for="flat-shading">Flat Shading (Faceted Look)</label>
      </div>
      
      <div class="control-row">
        <label>Smoothing Angle:</label>
        <input type="range" id="smoothing-angle" min="0" max="180" value="180" disabled>
        <span class="value-display" id="smoothing-angle-value">180¬∞</span>
      </div>
      
      <div class="control-row">
        <input type="checkbox" id="wireframe">
        <label for="wireframe">Show Wireframe</label>
      </div>
    </div>
    
    <!-- Laplacian Smoothing -->
    <div class="control-group">
      <h3>üåä Laplacian Smoothing</h3>
      
      <div class="control-row">
        <label>Iterations:</label>
        <input type="range" id="smooth-iterations" min="1" max="10" value="3">
        <span class="value-display" id="smooth-iterations-value">3</span>
      </div>
      
      <div class="control-row">
        <label>Lambda (Strength):</label>
        <input type="range" id="smooth-lambda" min="0" max="100" value="50">
        <span class="value-display" id="smooth-lambda-value">0.50</span>
      </div>
      
      <div class="control-row">
        <label>Method:</label>
        <select id="smooth-method">
          <option value="laplacian">Laplacian</option>
          <option value="taubin">Taubin (Volume Preserving)</option>
        </select>
      </div>
      
      <div class="control-row">
        <input type="checkbox" id="preserve-boundaries" checked>
        <label for="preserve-boundaries">Preserve Boundaries</label>
      </div>
      
      <button id="apply-smoothing">Apply Smoothing</button>
      <button id="reset-geometry">Reset Geometry</button>
    </div>
    
    <!-- Scene Lighting Controls -->
    <div class="control-group">
      <h3>‚òÄÔ∏è Scene Lighting</h3>
      
      <div class="control-row">
        <label>Ambient Color:</label>
        <input type="color" id="ambient-light-color" value="#a0a0a0">
      </div>
      
      <div class="control-row">
        <label>Ambient Intensity:</label>
        <input type="range" id="ambient-intensity" min="0" max="200" value="100">
        <span class="value-display" id="ambient-intensity-value">100%</span>
      </div>
      
      <div class="control-row">
        <label>Directional Color:</label>
        <input type="color" id="directional-light-color" value="#ffffff">
      </div>
      
      <div class="control-row">
        <label>Directional Intensity:</label>
        <input type="range" id="directional-intensity" min="0" max="200" value="120">
        <span class="value-display" id="directional-intensity-value">120%</span>
      </div>
      
      <div class="control-row">
        <label>Fill Light Intensity:</label>
        <input type="range" id="fill-intensity" min="0" max="100" value="50">
        <span class="value-display" id="fill-intensity-value">50%</span>
      </div>
      
      <div class="control-row">
        <label>Point Light:</label>
        <input type="checkbox" id="point-light-enabled">
        <input type="color" id="point-light-color" value="#ff4444" disabled>
      </div>
      
      <div class="control-row">
        <label>Point Intensity:</label>
        <input type="range" id="point-intensity" min="0" max="100" value="50" disabled>
        <span class="value-display" id="point-intensity-value">50%</span>
      </div>
    </div>
    
    <!-- Preset Configurations -->
    <div class="control-group">
      <h3>‚ö° Material Presets</h3>
      <div class="preset-buttons">
        <button id="preset-matte">Matte</button>
        <button id="preset-glossy">Glossy</button>
        <button id="preset-metal">Metal</button>
        <button id="preset-glow">Glow</button>
        <button id="preset-glass">Glass</button>
        <button id="preset-cartoon">Cartoon</button>
      </div>
    </div>
    
    <!-- Lighting Presets -->
    <div class="control-group">
      <h3>üí° Lighting Presets</h3>
      <div class="preset-buttons">
        <button id="light-preset-bright">Bright</button>
        <button id="light-preset-soft">Soft</button>
        <button id="light-preset-dramatic">Dramatic</button>
        <button id="light-preset-dark">Dark</button>
        <button id="light-preset-sunset">Sunset</button>
        <button id="light-preset-clinical">Clinical</button>
      </div>
    </div>
    
    <!-- Surface Selection -->
    <div class="control-group">
      <h3>üß† Brain Surface</h3>
      <div class="preset-buttons">
        <button id="load-pial">Brain Surface</button>
        <button id="load-sphere">Sphere</button>
      </div>
    </div>
    
    <!-- Additional Test Shapes -->
    <div class="control-group">
      <h3>üé≠ Test Shapes</h3>
      <div class="preset-buttons">
        <button id="load-torus">Torus</button>
        <button id="load-knot">Torus Knot</button>
        <button id="load-tetrahedron">Tetrahedron</button>
      </div>
    </div>
  </div>
  
  <div class="info-panel">
    <div class="info-item">
      <span class="info-label">FPS:</span>
      <span class="info-value" id="fps">0</span>
    </div>
    <div class="info-item">
      <span class="info-label">Vertices:</span>
      <span class="info-value" id="vertex-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-label">Faces:</span>
      <span class="info-value" id="face-count">0</span>
    </div>
    <div class="info-item">
      <span class="info-label">Smooth Count:</span>
      <span class="info-value" id="smooth-count">0</span>
    </div>
  </div>
  
  <script type="module">
    import { 
      NeuroSurfaceViewer,
      SurfaceGeometry,
      ColorMappedNeuroSurface,
      LaplacianSmoothing,
      THREE,
      setDebug,
      loadSurface
    } from './src/index.js';
    
    // Enable debug mode
    setDebug(true);
    
    // Create viewer
    const container = document.getElementById('viewer-container');
    const viewer = new NeuroSurfaceViewer(
      container,
      window.innerWidth,
      window.innerHeight,
      {
        showControls: false,
        backgroundColor: 0x1a1a2e
      }
    );
    
    // Start render loop
    viewer.startRenderLoop();
    
    // Track smoothing count
    let smoothingCount = 0;
    let originalGeometry = null;
    let currentSurface = null;
    
    // FPS tracking
    let frameCount = 0;
    let lastTime = performance.now();
    
    function updateFPS() {
      frameCount++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        document.getElementById('fps').textContent = frameCount;
        frameCount = 0;
        lastTime = now;
      }
      requestAnimationFrame(updateFPS);
    }
    updateFPS();
    
    // Create test surface
    async function createTestSurface(type = 'brain') {
      // Clear existing surfaces
      viewer.getSurfaceIds().forEach(id => {
        viewer.removeSurface(id);
      });
      
      let surfaceGeom;
      
      if (type === 'brain' || type === 'pial' || type === 'white' || type === 'inflated') {
        // Load brain surface - use ascii.surf.gii for all brain options for now
        try {
          let surfaceFile = './tests/data/ascii.surf.gii';
          
          console.log('Loading brain surface:', surfaceFile);
          surfaceGeom = await loadSurface(
            surfaceFile,
            'gifti',
            'lh',
            30000,
            true, // Auto-scale for better visibility
            100   // Scale to reasonable size
          );
        } catch (error) {
          console.error('Error loading brain surface, falling back to sphere:', error);
          // Fallback to sphere if brain surface fails to load
          const geometry = new THREE.SphereGeometry(50, 32, 32);
          const vertices = new Float32Array(geometry.attributes.position.array);
          const faces = geometry.index ? new Uint32Array(geometry.index.array) : new Uint32Array(0);
          surfaceGeom = new SurfaceGeometry(vertices, faces, 'test');
        }
      } else {
        // Create procedural geometry
        let geometry;
        switch(type) {
          case 'torus':
            geometry = new THREE.TorusGeometry(50, 20, 16, 32);
            break;
          case 'knot':
            geometry = new THREE.TorusKnotGeometry(40, 10, 100, 16);
            break;
          case 'tetrahedron':
            geometry = new THREE.TetrahedronGeometry(60, 2);
            break;
          default: // sphere
            geometry = new THREE.SphereGeometry(50, 32, 32);
        }
        
        const vertices = new Float32Array(geometry.attributes.position.array);
        const faces = geometry.index ? new Uint32Array(geometry.index.array) : new Uint32Array(0);
        surfaceGeom = new SurfaceGeometry(vertices, faces, 'test');
      }
      
      // Store original geometry for reset
      // The SurfaceGeometry constructor creates new TypedArrays, which are copies
      originalGeometry = new SurfaceGeometry(
        surfaceGeom.vertices,  // SurfaceGeometry constructor will create a copy
        surfaceGeom.faces,     // SurfaceGeometry constructor will create a copy
        surfaceGeom.hemi,
        surfaceGeom.vertexCurv
      );
      
      // Create data for coloring
      const vertexCount = surfaceGeom.vertices.length / 3;
      const data = new Float32Array(vertexCount);
      
      // Calculate bounding box for better data normalization
      let minY = Infinity, maxY = -Infinity;
      for (let i = 0; i < vertexCount; i++) {
        const y = surfaceGeom.vertices[i * 3 + 1];
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
      }
      
      // Color based on y-coordinate (height)
      const range = maxY - minY || 1;
      for (let i = 0; i < vertexCount; i++) {
        const y = surfaceGeom.vertices[i * 3 + 1];
        data[i] = ((y - minY) / range) * 100; // Normalize to 0-100
      }
      
      // Create color mapped surface with initial config
      currentSurface = new ColorMappedNeuroSurface(
        surfaceGeom,
        null,
        data,
        'viridis',
        {
          alpha: 1.0,
          flatShading: false,
          shininess: 50,
          specularColor: 0x666666,  // Lighter specular for better highlights
          emissive: 0x0a0a0a,       // Slight self-illumination
          emissiveIntensity: 0.1    // Small amount for better visibility
        }
      );
      
      viewer.addSurface(currentSurface, 'test-surface');
      viewer.centerCamera();
      
      // Update info
      document.getElementById('vertex-count').textContent = vertexCount;
      document.getElementById('face-count').textContent = surfaceGeom.faces.length / 3;
      smoothingCount = 0;
      document.getElementById('smooth-count').textContent = smoothingCount;
    }
    
    /**
     * Update surface material properties based on UI controls
     * This demonstrates how to map UI controls to the surface.updateConfig() API
     */
    function updateMaterial() {
      if (!currentSurface) return;
      
      // Gather all material properties from UI controls
      const config = {
        color: document.getElementById('base-color').value,
        shininess: parseInt(document.getElementById('shininess').value),
        specularColor: document.getElementById('specular-color').value,
        emissive: document.getElementById('emissive-color').value,
        emissiveIntensity: parseInt(document.getElementById('emissive-intensity').value) / 100,
        alpha: parseInt(document.getElementById('opacity').value) / 100,
        flatShading: document.getElementById('flat-shading').checked
      };
      
      // Update smoothing angle if smooth shading
      if (!config.flatShading) {
        const smoothingAngle = parseInt(document.getElementById('smoothing-angle').value);
        if (smoothingAngle < 180) {
          config.smoothingAngle = smoothingAngle;
        }
      }
      
      currentSurface.updateConfig(config);
      
      // Handle wireframe separately
      if (currentSurface.mesh && currentSurface.mesh.material) {
        currentSurface.mesh.material.wireframe = document.getElementById('wireframe').checked;
      }
      
      viewer.render();
    }
    
    // Connect sliders to displays
    document.getElementById('shininess').addEventListener('input', (e) => {
      document.getElementById('shininess-value').textContent = e.target.value;
      updateMaterial();
    });
    
    document.getElementById('emissive-intensity').addEventListener('input', (e) => {
      document.getElementById('emissive-intensity-value').textContent = e.target.value;
      updateMaterial();
    });
    
    document.getElementById('opacity').addEventListener('input', (e) => {
      document.getElementById('opacity-value').textContent = e.target.value;
      updateMaterial();
    });
    
    document.getElementById('smoothing-angle').addEventListener('input', (e) => {
      document.getElementById('smoothing-angle-value').textContent = e.target.value + '¬∞';
      updateMaterial();
    });
    
    document.getElementById('smooth-iterations').addEventListener('input', (e) => {
      document.getElementById('smooth-iterations-value').textContent = e.target.value;
    });
    
    document.getElementById('smooth-lambda').addEventListener('input', (e) => {
      document.getElementById('smooth-lambda-value').textContent = (e.target.value / 100).toFixed(2);
    });
    
    // Color pickers
    document.getElementById('base-color').addEventListener('change', updateMaterial);
    document.getElementById('specular-color').addEventListener('change', updateMaterial);
    document.getElementById('emissive-color').addEventListener('change', updateMaterial);
    
    // Checkboxes
    document.getElementById('flat-shading').addEventListener('change', (e) => {
      document.getElementById('smoothing-angle').disabled = e.target.checked;
      updateMaterial();
    });
    document.getElementById('wireframe').addEventListener('change', updateMaterial);
    
    /**
     * Apply Laplacian smoothing to the surface geometry
     * Demonstrates the applyLaplacianSmoothing() API
     * - iterations: Number of smoothing passes (more = smoother)
     * - lambda: Strength per iteration (0-1)
     * - method: 'laplacian' (may shrink) or 'taubin' (preserves volume)
     * - preserveBoundaries: Keep edges fixed to prevent distortion
     */
    document.getElementById('apply-smoothing').addEventListener('click', () => {
      if (!currentSurface) return;
      
      const iterations = parseInt(document.getElementById('smooth-iterations').value);
      const lambda = parseInt(document.getElementById('smooth-lambda').value) / 100;
      const method = document.getElementById('smooth-method').value;
      const preserveBoundaries = document.getElementById('preserve-boundaries').checked;
      
      currentSurface.applyLaplacianSmoothing(
        iterations,
        lambda,
        method,
        preserveBoundaries
      );
      
      smoothingCount++;
      document.getElementById('smooth-count').textContent = smoothingCount;
      
      viewer.render();
    });
    
    // Reset geometry
    document.getElementById('reset-geometry').addEventListener('click', () => {
      if (!originalGeometry || !currentSurface) return;
      
      // Reset vertices to original
      if (currentSurface.mesh && currentSurface.mesh.geometry) {
        const positionAttribute = currentSurface.mesh.geometry.getAttribute('position');
        positionAttribute.array.set(originalGeometry.vertices);
        positionAttribute.needsUpdate = true;
        
        // Also update the surface's internal geometry reference
        currentSurface.geometry.vertices.set(originalGeometry.vertices);
        
        // Recompute normals and bounds
        currentSurface.mesh.geometry.computeVertexNormals();
        currentSurface.mesh.geometry.computeBoundingBox();
        currentSurface.mesh.geometry.computeBoundingSphere();
        
        console.log('Geometry reset to original');
      }
      
      smoothingCount = 0;
      document.getElementById('smooth-count').textContent = smoothingCount;
      
      viewer.render();
    });
    
    /**
     * MATERIAL PRESETS
     * Common material configurations for quick setup
     * Each preset sets multiple properties for a specific look
     */
    
    // Matte: Low shininess, minimal specular for dull surfaces
    document.getElementById('preset-matte').addEventListener('click', () => {
      document.getElementById('shininess').value = 10;
      document.getElementById('shininess-value').textContent = '10';
      document.getElementById('specular-color').value = '#050505';
      document.getElementById('emissive-intensity').value = 0;
      document.getElementById('emissive-intensity-value').textContent = '0';
      updateMaterial();
    });
    
    document.getElementById('preset-glossy').addEventListener('click', () => {
      document.getElementById('shininess').value = 100;
      document.getElementById('shininess-value').textContent = '100';
      document.getElementById('specular-color').value = '#ffffff';
      document.getElementById('emissive-intensity').value = 0;
      document.getElementById('emissive-intensity-value').textContent = '0';
      updateMaterial();
    });
    
    document.getElementById('preset-metal').addEventListener('click', () => {
      document.getElementById('shininess').value = 200;
      document.getElementById('shininess-value').textContent = '200';
      document.getElementById('specular-color').value = '#888888';
      document.getElementById('base-color').value = '#444444';
      document.getElementById('emissive-intensity').value = 0;
      document.getElementById('emissive-intensity-value').textContent = '0';
      updateMaterial();
    });
    
    document.getElementById('preset-glow').addEventListener('click', () => {
      document.getElementById('emissive-color').value = '#00ff00';
      document.getElementById('emissive-intensity').value = 50;
      document.getElementById('emissive-intensity-value').textContent = '50';
      document.getElementById('shininess').value = 30;
      document.getElementById('shininess-value').textContent = '30';
      updateMaterial();
    });
    
    document.getElementById('preset-glass').addEventListener('click', () => {
      document.getElementById('opacity').value = 30;
      document.getElementById('opacity-value').textContent = '30';
      document.getElementById('shininess').value = 150;
      document.getElementById('shininess-value').textContent = '150';
      document.getElementById('specular-color').value = '#ffffff';
      updateMaterial();
    });
    
    document.getElementById('preset-cartoon').addEventListener('click', () => {
      document.getElementById('flat-shading').checked = true;
      document.getElementById('smoothing-angle').disabled = true;
      document.getElementById('shininess').value = 5;
      document.getElementById('shininess-value').textContent = '5';
      document.getElementById('specular-color').value = '#000000';
      updateMaterial();
    });
    
    // Brain surface loaders
    document.getElementById('load-pial').addEventListener('click', () => createTestSurface('pial'));
    document.getElementById('load-sphere').addEventListener('click', () => createTestSurface('sphere'));
    
    // Test shape loaders
    document.getElementById('load-torus').addEventListener('click', () => createTestSurface('torus'));
    document.getElementById('load-knot').addEventListener('click', () => createTestSurface('knot'));
    document.getElementById('load-tetrahedron').addEventListener('click', () => createTestSurface('tetrahedron'));
    
    // Initialize with brain pial surface
    createTestSurface('pial');
    
    // Handle window resize
    window.addEventListener('resize', () => {
      viewer.resize(window.innerWidth, window.innerHeight);
    });
    
    /**
     * SCENE LIGHTING SETUP
     * Demonstrates how to configure scene lighting for optimal surface visualization
     * We remove the default lights and add our own configurable lights
     */
    
    // Remove default viewer lights to have full control
    viewer.scene.remove(viewer.ambientLight);
    viewer.scene.remove(viewer.directionalLight);
    
    // Create custom lights that can be controlled via UI
    const ambientLight = new THREE.AmbientLight(0xa0a0a0, 1.0);
    viewer.scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
    directionalLight.position.set(100, 100, 50);
    viewer.scene.add(directionalLight);
    
    const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
    fillLight.position.set(-100, -100, -50);
    viewer.scene.add(fillLight);
    
    const pointLight = new THREE.PointLight(0xff4444, 1.0, 1000);
    pointLight.position.set(0, 50, 100);
    pointLight.visible = false; // Start disabled
    viewer.scene.add(pointLight);
    
    // Add a helper to visualize the point light position (optional)
    const pointLightHelper = new THREE.PointLightHelper(pointLight, 10);
    pointLightHelper.visible = false;
    viewer.scene.add(pointLightHelper);
    
    // Lighting control functions
    function updateLighting() {
      viewer.render();
    }
    
    // Ambient light controls
    document.getElementById('ambient-light-color').addEventListener('change', (e) => {
      ambientLight.color.set(e.target.value);
      updateLighting();
    });
    
    document.getElementById('ambient-intensity').addEventListener('input', (e) => {
      const intensity = e.target.value / 100;
      ambientLight.intensity = intensity;
      document.getElementById('ambient-intensity-value').textContent = e.target.value + '%';
      updateLighting();
    });
    
    // Directional light controls
    document.getElementById('directional-light-color').addEventListener('change', (e) => {
      directionalLight.color.set(e.target.value);
      updateLighting();
    });
    
    document.getElementById('directional-intensity').addEventListener('input', (e) => {
      const intensity = e.target.value / 100;
      directionalLight.intensity = intensity;
      document.getElementById('directional-intensity-value').textContent = e.target.value + '%';
      updateLighting();
    });
    
    // Fill light control
    document.getElementById('fill-intensity').addEventListener('input', (e) => {
      const intensity = e.target.value / 100;
      fillLight.intensity = intensity;
      document.getElementById('fill-intensity-value').textContent = e.target.value + '%';
      updateLighting();
    });
    
    // Point light controls
    document.getElementById('point-light-enabled').addEventListener('change', (e) => {
      pointLight.visible = e.target.checked;
      pointLightHelper.visible = e.target.checked; // Show/hide helper with light
      document.getElementById('point-light-color').disabled = !e.target.checked;
      document.getElementById('point-intensity').disabled = !e.target.checked;
      
      // Set initial intensity when enabling
      if (e.target.checked) {
        const sliderValue = document.getElementById('point-intensity').value;
        const intensity = (sliderValue / 100) * 2.0;
        pointLight.intensity = intensity;
        console.log('Point light enabled with intensity:', intensity);
      }
      
      updateLighting();
    });
    
    document.getElementById('point-light-color').addEventListener('change', (e) => {
      pointLight.color.set(e.target.value);
      updateLighting();
    });
    
    document.getElementById('point-intensity').addEventListener('input', (e) => {
      const intensity = (e.target.value / 100) * 5.0; // Scale up to 5.0 max for much better visibility
      pointLight.intensity = intensity;
      document.getElementById('point-intensity-value').textContent = e.target.value + '%';
      console.log('Point light intensity set to:', intensity, 'visible:', pointLight.visible, 'position:', pointLight.position);
      
      // Force update the helper if visible
      if (pointLightHelper.visible) {
        pointLightHelper.update();
      }
      
      updateLighting();
    });
    
    // Lighting presets
    document.getElementById('light-preset-bright').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#b0b0b0';
      document.getElementById('ambient-intensity').value = 120;
      document.getElementById('directional-light-color').value = '#ffffff';
      document.getElementById('directional-intensity').value = 150;
      document.getElementById('fill-intensity').value = 70;
      
      ambientLight.color.set('#b0b0b0');
      ambientLight.intensity = 1.2;
      directionalLight.color.set('#ffffff');
      directionalLight.intensity = 1.5;
      fillLight.intensity = 0.7;
      
      document.getElementById('ambient-intensity-value').textContent = '120%';
      document.getElementById('directional-intensity-value').textContent = '150%';
      document.getElementById('fill-intensity-value').textContent = '70%';
      updateLighting();
    });
    
    document.getElementById('light-preset-soft').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#a0a0a0';
      document.getElementById('ambient-intensity').value = 100;
      document.getElementById('directional-light-color').value = '#fffaf0';
      document.getElementById('directional-intensity').value = 80;
      document.getElementById('fill-intensity').value = 60;
      
      ambientLight.color.set('#a0a0a0');
      ambientLight.intensity = 1.0;
      directionalLight.color.set('#fffaf0');
      directionalLight.intensity = 0.8;
      fillLight.intensity = 0.6;
      
      document.getElementById('ambient-intensity-value').textContent = '100%';
      document.getElementById('directional-intensity-value').textContent = '80%';
      document.getElementById('fill-intensity-value').textContent = '60%';
      updateLighting();
    });
    
    document.getElementById('light-preset-dramatic').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#404040';
      document.getElementById('ambient-intensity').value = 40;
      document.getElementById('directional-light-color').value = '#ffffff';
      document.getElementById('directional-intensity').value = 200;
      document.getElementById('fill-intensity').value = 10;
      
      ambientLight.color.set('#404040');
      ambientLight.intensity = 0.4;
      directionalLight.color.set('#ffffff');
      directionalLight.intensity = 2.0;
      fillLight.intensity = 0.1;
      
      document.getElementById('ambient-intensity-value').textContent = '40%';
      document.getElementById('directional-intensity-value').textContent = '200%';
      document.getElementById('fill-intensity-value').textContent = '10%';
      updateLighting();
    });
    
    document.getElementById('light-preset-dark').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#202020';
      document.getElementById('ambient-intensity').value = 30;
      document.getElementById('directional-light-color').value = '#808080';
      document.getElementById('directional-intensity').value = 50;
      document.getElementById('fill-intensity').value = 20;
      
      ambientLight.color.set('#202020');
      ambientLight.intensity = 0.3;
      directionalLight.color.set('#808080');
      directionalLight.intensity = 0.5;
      fillLight.intensity = 0.2;
      
      document.getElementById('ambient-intensity-value').textContent = '30%';
      document.getElementById('directional-intensity-value').textContent = '50%';
      document.getElementById('fill-intensity-value').textContent = '20%';
      updateLighting();
    });
    
    document.getElementById('light-preset-sunset').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#ffa050';
      document.getElementById('ambient-intensity').value = 80;
      document.getElementById('directional-light-color').value = '#ffcc66';
      document.getElementById('directional-intensity').value = 100;
      document.getElementById('fill-intensity').value = 40;
      
      ambientLight.color.set('#ffa050');
      ambientLight.intensity = 0.8;
      directionalLight.color.set('#ffcc66');
      directionalLight.intensity = 1.0;
      fillLight.intensity = 0.4;
      
      document.getElementById('ambient-intensity-value').textContent = '80%';
      document.getElementById('directional-intensity-value').textContent = '100%';
      document.getElementById('fill-intensity-value').textContent = '40%';
      updateLighting();
    });
    
    document.getElementById('light-preset-clinical').addEventListener('click', () => {
      document.getElementById('ambient-light-color').value = '#f0f0f0';
      document.getElementById('ambient-intensity').value = 110;
      document.getElementById('directional-light-color').value = '#ffffff';
      document.getElementById('directional-intensity').value = 100;
      document.getElementById('fill-intensity').value = 80;
      
      ambientLight.color.set('#f0f0f0');
      ambientLight.intensity = 1.1;
      directionalLight.color.set('#ffffff');
      directionalLight.intensity = 1.0;
      fillLight.intensity = 0.8;
      
      document.getElementById('ambient-intensity-value').textContent = '110%';
      document.getElementById('directional-intensity-value').textContent = '100%';
      document.getElementById('fill-intensity-value').textContent = '80%';
      updateLighting();
    });
  </script>
</body>
</html>